import React from 'react';
import { ChevronDown, CheckCircle, XCircle, ArrowDown } from 'lucide-react';

interface NodeProps {
  label: string;
  color?: string;
  className?: string;
}

const FlowNode: React.FC<NodeProps> = ({ label, color = 'bg-white', className = '' }) => (
  <div className={`${color} rounded px-6 py-4 shadow-sm border ${className}`}>
    <span className="font-medium text-sm">{label}</span>
  </div>
);

const Arrow: React.FC<{ label?: string; className?: string }> = ({ label, className = '' }) => (
  <div className={`flex flex-col items-center ${className}`}>
    <ArrowDown className="w-5 h-5 text-slate-300" strokeWidth={2} />
    {label && <span className="text-xs text-slate-500 mt-2 max-w-md text-center leading-relaxed">{label}</span>}
  </div>
);

type TierView = 'A' | 'B' | 'C';

export const FlowchartVisualization: React.FC = () => {
  const [activeTier, setActiveTier] = React.useState<TierView>('A');

  return (
    <div className="max-w-7xl mx-auto space-y-6">
      {/* Phase 1: Parallel Institutional and Individual Agreements */}
      <section className="bg-white border-l-4 border-[#7376BF] shadow-sm p-8">
        <div className="mb-6 text-center">
          <h2 className="text-xl font-bold text-slate-800 uppercase tracking-wide">
            Institutional and Individual Agreements
          </h2>
        </div>
        
        {/* Control Mechanism box - moved to top */}
        <div className="mb-6">
          <div className="bg-[#D18C4B]/20 border border-[#D18C4B] rounded px-4 py-3">
            <p className="text-xs font-semibold text-slate-800 mb-1">Control Mechanism:</p>
            <p className="text-xs text-slate-700">Parallel accountability structure ensures that both sites (institutional agreements) and researchers (individual and PI commitments) formally commit to ethical and legal compliance prior to data access request advancement.</p>
          </div>
        </div>
        
        <div className="grid grid-cols-2 gap-8 mb-6">
          {/* Left: Site Contributions */}
          <div className="flex flex-col items-center gap-4">
            <div className="text-xs font-semibold text-[#7376BF] uppercase tracking-wider mb-2">Site Contributions</div>
            <FlowNode 
              label="Institutional Data Use Agreement (DUA)" 
              color="bg-[#7376BF]/10 border-[#7376BF]"
              className="w-full text-center"
            />
            <div className="text-xs text-slate-600 text-center max-w-sm">
              Establishes the permitted uses of the Data by the signing institution as assured by the signatory Institution
            </div>
            <Arrow />
            <FlowNode 
              label="Data Transfer Agreement (DTA)" 
              color="bg-[#7376BF]/10 border-[#7376BF]"
              className="w-full text-center"
            />
            <div className="text-xs text-slate-600 text-center max-w-sm">
              Sites sign DTA and submit a standard payload
            </div>
          </div>
          
          {/* Right: Researcher Contributions */}
          <div className="flex flex-col items-center gap-4">
            <div className="text-xs font-semibold text-[#56ABF5] uppercase tracking-wider mb-2">Researcher Contributions</div>
            <div className="flex flex-col gap-3 w-full">
              <FlowNode 
                label="Individual: Signs Data Access Request (DAR)" 
                color="bg-[#56ABF5]/10 border-[#56ABF5]"
                className="w-full text-center"
              />
              <Arrow />
              <FlowNode 
                label="Personal Investigators (PI): Follow Controlled Access Data Repository (CADR) Protocols" 
                color="bg-[#56ABF5]/10 border-[#56ABF5]"
                className="w-full text-center"
              />
            </div>
          </div>
        </div>
      </section>

      <Arrow />

      {/* Phase 2 & 3: Parallel Site Tier Selection + Researcher Phenotype Definition â†’ Committee Review */}
      <section className="bg-white border-l-4 border-[#93C954] shadow-sm p-8">
        <div className="mb-6 text-center">
          <h2 className="text-xl font-bold text-slate-800 uppercase tracking-wide">
            Creation of Dynamic Workspaces
          </h2>
        </div>
        
        {/* Control Mechanism box - moved to top */}
        <div className="mb-6">
          <div className="bg-[#D18C4B]/20 border border-[#D18C4B] rounded px-4 py-3">
            <p className="text-xs font-semibold text-slate-800 mb-1">Control Mechanism:</p>
            <p className="text-xs text-slate-700">While sites share data based on their agreed upon tier structure (A, B, or C), researchers define their phenotypes and declare question-relevant codes to be used in analysis. These parallel streams converge at the DAR Review Committee where Subject Matter Experts assess proposals and provide feedback to researchers.</p>
          </div>
        </div>
        
        <div className="grid grid-cols-2 gap-8 mb-6">
          {/* Left: Site Tier Selection */}
          <div className="flex flex-col items-center gap-4">
            <div className="text-xs font-semibold text-[#7376BF] uppercase tracking-wider mb-2">Site Contributions</div>
            <FlowNode 
              label="Sites Select Trust Tier" 
              color="bg-[#7376BF]/10 border-[#7376BF]"
              className="w-full text-center"
            />
            <Arrow />
            
            {/* Tier-Specific View Selector */}
            <div className="bg-slate-100 rounded-lg p-4 w-full border border-slate-300">
              <div className="flex gap-2 justify-center">
                <button
                  onClick={() => setActiveTier('A')}
                  className={`px-4 py-2 rounded text-sm font-semibold transition-colors ${
                    activeTier === 'A'
                      ? 'bg-blue-600 text-white'
                      : 'bg-white text-slate-700 border border-slate-300 hover:bg-slate-50'
                  }`}
                >
                  Tier A
                </button>
                <button
                  onClick={() => setActiveTier('B')}
                  className={`px-4 py-2 rounded text-sm font-semibold transition-colors ${
                    activeTier === 'B'
                      ? 'bg-blue-600 text-white'
                      : 'bg-white text-slate-700 border border-slate-300 hover:bg-slate-50'
                  }`}
                >
                  Tier B
                </button>
                <button
                  onClick={() => setActiveTier('C')}
                  className={`px-4 py-2 rounded text-sm font-semibold transition-colors ${
                    activeTier === 'C'
                      ? 'bg-blue-600 text-white'
                      : 'bg-white text-slate-700 border border-slate-300 hover:bg-slate-50'
                  }`}
                >
                  Tier C
                </button>
              </div>
            </div>

            {/* Three-column tier display */}
            <div className="grid grid-cols-3 gap-3 w-full mt-4">
              {/* Tier A Column */}
              <div className={`transition-opacity ${activeTier !== 'A' ? 'opacity-30' : ''}`}>
                <div className="bg-slate-50 border border-slate-300 rounded px-3 py-2 text-center">
                  <div className="text-xs font-semibold text-slate-800 uppercase">Trust Model</div>
                </div>
                <div className="mt-3 text-xs text-slate-600 text-center">
                  <p className="font-semibold mb-2">NIH DAC Authorized</p>
                  <p className="text-[10px]">The institution delegates review authority to the federal N3C DAC. Data is included in all approved projects automatically.</p>
                </div>
              </div>

              {/* Tier B Column */}
              <div className={`transition-opacity ${activeTier !== 'B' ? 'opacity-30' : ''}`}>
                <div className="bg-slate-50 border border-slate-300 rounded px-3 py-2 text-center">
                  <div className="text-xs font-semibold text-slate-800 uppercase">Rules Model</div>
                </div>
                <div className="mt-3 text-xs text-slate-600 text-center">
                  <p className="font-semibold mb-1">Data Use Limitations (DUL)</p>
                  <p className="text-[10px]">Sites create rules to limit the use of their data (e.g. specific EHR codes, patient populations, datatypes, or institution types).</p>
                </div>
                
                {/* NIH Data Access Committee - within Tier B */}
                <div className="mt-6 flex flex-col items-center gap-3">
                  <div className="bg-[#93C954]/20 border border-[#93C954] rounded px-4 py-3 w-full text-center">
                    <h3 className="font-bold text-xs uppercase tracking-wide mb-1">NIH Data Access Committee</h3>
                    <p className="text-[9px] text-slate-600 uppercase tracking-wide">Final Formal Review</p>
                  </div>
                </div>
                
                {/* Risk and Control for Tier B */}
                <div className="space-y-3 mt-3">
                  <div className="bg-[#EDEA1F]/20 border border-[#EDEA1F] rounded px-2 py-2">
                    <p className="text-[10px] font-semibold text-slate-800">Risk:</p>
                    <p className="text-[9px] text-slate-700 mt-1">Excluded codes may be at risk of being included if they are not accurately reported in phenotypes or relevant codes.</p>
                  </div>
                  <div className="bg-[#D18C4B]/20 border border-[#D18C4B] rounded px-2 py-2">
                    <p className="text-[10px] font-semibold text-slate-800">Control:</p>
                    <p className="text-[9px] text-slate-700 mt-1">NIH DAC reviews research intent</p>
                  </div>
                </div>
              </div>

              {/* Tier C Column */}
              <div className={`transition-opacity ${activeTier !== 'C' ? 'opacity-30' : ''}`}>
                <div className="bg-slate-50 border border-slate-300 rounded px-3 py-2 text-center">
                  <div className="text-xs font-semibold text-slate-800">Tier C</div>
                  <div className="text-[10px] text-slate-500 uppercase mt-1">Dynamic Model</div>
                </div>
                
                {/* Manual Site Opt-In Section */}
                <div className="bg-slate-50 rounded p-3 mb-3 mt-3">
                  <p className="text-[10px] font-semibold text-slate-700 mb-2 text-center uppercase tracking-wide">Manual Site Opt-In</p>
                  <div className="bg-white border border-slate-300 rounded px-2 py-2 text-center mb-2">
                    <p className="text-[9px] text-slate-700">
                      Institutions review every Data Access Request within a 30-day window.
                    </p>
                  </div>
                  <div className="bg-white border border-slate-300 rounded px-2 py-2 text-center">
                    <p className="text-[9px] text-slate-700">
                      If sites do not approve within <span className="font-semibold">30-day window</span>, site is <span className="font-semibold text-green-700">included in study</span>.
                    </p>
                  </div>
                </div>
                
                {/* NIH Data Access Committee - within Tier C */}
                <div className="mt-3 flex flex-col items-center gap-3">
                  <div className="bg-[#93C954]/20 border border-[#93C954] rounded px-4 py-3 w-full text-center">
                    <h3 className="font-bold text-xs uppercase tracking-wide mb-1">NIH Data Access Committee</h3>
                    <p className="text-[9px] text-slate-600 uppercase tracking-wide">Final Formal Review</p>
                  </div>
                </div>
                
                {/* Risk and Control for Tier C */}
                <div className="space-y-3 mt-3">
                  <div className="bg-[#EDEA1F]/20 border border-[#EDEA1F] rounded px-2 py-2">
                    <p className="text-[10px] font-semibold text-slate-800">Risk:</p>
                    <p className="text-[9px] text-slate-700 mt-1">Sites may miss review window</p>
                  </div>
                  <div className="bg-[#D18C4B]/20 border border-[#D18C4B] rounded px-2 py-2">
                    <p className="text-[10px] font-semibold text-slate-800">Control:</p>
                    <p className="text-[9px] text-slate-700 mt-1">Default inclusion after 30 days ensures research continuity</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          {/* Right: Researcher Phenotype Definition + DAR Review */}
          <div className="flex flex-col items-center gap-4 relative">
            <div className="text-xs font-semibold text-[#56ABF5] uppercase tracking-wider mb-2">Researcher Contributions</div>
            <FlowNode 
              label="Researchers Define Phenotype" 
              color="bg-[#56ABF5]/10 border-[#56ABF5]"
              className="w-full text-center"
            />
            <Arrow />
            <FlowNode 
              label="Declare Additional 'Relevant Codes'" 
              color="bg-[#56ABF5]/10 border-[#56ABF5]"
              className="w-full text-center"
            />
            
            <Arrow />
            
            <FlowNode 
              label="DAR Review Committee" 
              color="bg-[#93C954]/10 border-[#93C954]"
              className="w-full text-center"
            />
            
            {/* Half-moon curved feedback arrow on the right side */}
            <svg 
              className="absolute -right-4 top-16 pointer-events-none" 
              width="100" 
              height="280" 
              viewBox="0 0 100 280"
            >
              {/* Curved path */}
              <path
                d="M 10 20 Q 70 140 10 260"
                fill="none"
                stroke="#EDEA1F"
                strokeWidth="3"
              />
              {/* Top arrow pointing to Researchers Define Phenotype */}
              <polygon
                points="10,20 6,28 14,28"
                fill="#EDEA1F"
              />
              {/* Bottom arrow pointing to DAR Review Committee */}
              <polygon
                points="10,260 14,252 6,252"
                fill="#EDEA1F"
              />
              {/* Label */}
              <text
                x="50"
                y="130"
                fill="#4b5563"
                fontSize="9"
                fontWeight="600"
                textAnchor="middle"
              >
                ITERATIVE
              </text>
              <text
                x="50"
                y="142"
                fill="#4b5563"
                fontSize="9"
                fontWeight="600"
                textAnchor="middle"
              >
                FEEDBACK
              </text>
            </svg>
          </div>
        </div>
      </section>

      <Arrow />

      {/* Researchers Submit Data Use Request */}
      <section className="flex flex-col items-center gap-4 py-4">
        <div className="bg-[#56ABF5]/10 border-[#56ABF5] border rounded w-full max-w-lg px-10 py-6 flex flex-col items-center justify-center shadow-sm">
          <h3 className="font-semibold text-slate-800 text-base text-center mb-2">Researchers Submit Data Use Request</h3>
          <p className="text-xs text-slate-600 text-center">DURs are time-limited (1 year) and renewable (twice). Phenotypes may be reused across studies.</p>
        </div>
      </section>

      <Arrow label="A secure workspace is provisioned with approved data, including linked external datasets. Access is restricted to authorized team members." />

      {/* The Enclave */}
      <section className="flex flex-col items-center gap-4 py-4">
        <div className="bg-[#116F0E] text-white rounded w-full max-w-lg px-10 py-8 flex flex-col items-center justify-center shadow-lg border-2 border-[#0d5009]">
          <h3 className="font-bold text-lg text-center uppercase tracking-wide">Secure Research Enclave</h3>
        </div>
        <div className="max-w-xl text-center bg-slate-50 border border-slate-200 rounded p-4 text-sm text-slate-600 leading-relaxed">
          Analysis occurs within a FedRAMP-authorized enclave. ISAs enable access to HPC environments for advanced analytics.
        </div>
        
        {/* Risk and Control boxes */}
        <div className="grid grid-cols-2 gap-4 mt-4 w-full max-w-xl">
          <div className="bg-[#EDEA1F]/20 border border-[#EDEA1F] rounded px-4 py-3">
            <p className="text-xs font-semibold text-slate-800 mb-1">Risk:</p>
            <p className="text-xs text-slate-700">Malicious actors may copy row level data or export datasets without DAC approval. This behavior is a direct violation of the previous agreements which are monitored and audited to take action in the event of a violation.</p>
          </div>
          <div className="bg-[#D18C4B]/20 border border-[#D18C4B] rounded px-4 py-3">
            <p className="text-xs font-semibold text-slate-800 mb-1">Control Mechanism:</p>
            <p className="text-xs text-slate-700">Approved researchers access data exclusively within a highly controlled, continuously audited environment. Direct data export is prohibited without final publication committee approval.</p>
          </div>
        </div>
      </section>

      <Arrow />

      {/* Final Backstop */}
      <section className="flex flex-col items-center gap-4 py-4">
        <div className="bg-white border border-slate-300 rounded px-10 py-5 shadow-sm w-full max-w-md text-center">
          <h3 className="font-semibold text-slate-800 mb-1 uppercase tracking-wide">Download Request</h3>
          <p className="text-xs text-slate-500 mt-2">Researchers apply to download data that complies with download policy.</p>
        </div>
        
        {/* Risk and Control boxes for Download Request */}
        <div className="grid grid-cols-2 gap-4 w-full max-w-md">
          <div className="bg-[#EDEA1F]/20 border border-[#EDEA1F] rounded px-4 py-3">
            <p className="text-xs font-semibold text-slate-800 mb-1">Risk:</p>
            <p className="text-xs text-slate-700">If policy is not followed, row level, non-aggregate data could be removed from enclave.</p>
          </div>
          <div className="bg-[#D18C4B]/20 border border-[#D18C4B] rounded px-4 py-3">
            <p className="text-xs font-semibold text-slate-800 mb-1">Control Mechanism:</p>
            <p className="text-xs text-slate-700">DAC reviews and approves request to ensure compliance.</p>
          </div>
        </div>
        
        <Arrow />
        
        <div className="bg-white border border-slate-300 rounded px-10 py-5 shadow-sm w-full max-w-md text-center">
          <h3 className="font-semibold text-slate-800 mb-1 uppercase tracking-wide">Publication Committee</h3>
          <p className="text-xs text-slate-500 uppercase tracking-wide">Protocol Compliance Audit</p>
        </div>
        
        {/* Risk and Control boxes for Publication Committee */}
        <div className="grid grid-cols-2 gap-4 w-full max-w-md">
          <div className="bg-[#EDEA1F]/20 border border-[#EDEA1F] rounded px-4 py-3">
            <p className="text-xs font-semibold text-slate-800 mb-1">Risk:</p>
            <p className="text-xs text-slate-700">[Risk content to be added]</p>
          </div>
          <div className="bg-[#D18C4B]/20 border border-[#D18C4B] rounded px-4 py-3">
            <p className="text-xs font-semibold text-slate-800 mb-1">Control Mechanism:</p>
            <p className="text-xs text-slate-700">[Control mechanism details to be added]</p>
          </div>
        </div>
        
        <Arrow />
        <div className="bg-[#389e0d] text-white rounded px-10 py-5 shadow-md border border-[#2d7a0a] w-full max-w-md text-center">
          <span className="font-bold uppercase tracking-wide">Approved Results Export</span>
        </div>
      </section>
    </div>
  );
};
